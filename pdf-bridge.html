<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Opening document…</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{min-height:100%;display:grid;place-items:center;background:#fff}
    .card{max-width:560px;margin:16px;padding:20px;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 8px 24px -12px rgba(0,0,0,.12)}
    .title{font-weight:700;color:#111827;margin:0 0 8px}
    .p{color:#4b5563;margin:0 0 10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:9999px;border:1px solid #e5e7eb;background:#f9fafb;color:#111827;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">Opening document…</h1>
      <p class="p">If nothing happens, tap the button below.</p>
      <p><a id="manual" class="btn" href="#" rel="noopener">Open manually</a></p>
    </div>
  </div>
  <script>
    const qs = new URLSearchParams(location.search);
    let u = qs.get('u') || '';
    const mode = (qs.get('mode') || 'preview').toLowerCase(); // 'preview' | 'download'

    function decodeTry(x){ try{ return decodeURIComponent(x); }catch{ return x; } }
    u = decodeTry(u);

    function isDrive(url){ return /drive\.google\.com/.test(url); }
    function driveId(url){
      return (url.match(/\/d\/([^/]+)/)?.[1]) || (url.match(/[?&]id=([^&]+)/)?.[1]) || '';
    }
    function toPreview(url){
      const id = driveId(url); if(!id) return url;
      return `https://drive.google.com/file/d/${id}/preview`;
    }
    function toDownload(url){
      const id = driveId(url); if(!id) return url;
      return `https://drive.google.com/uc?export=download&id=${id}`;
    }

    const finalUrl = isDrive(u) ? (mode==='download' ? toDownload(u) : toPreview(u)) : u;

    // ตั้งลิงก์สำรอง
    document.getElementById('manual').href = finalUrl;

    // รีไดเรกต์อัตโนมัติ (ใช้ replace เพื่อไม่ทิ้งประวัติ stack เกินไป)
    setTimeout(()=>location.replace(finalUrl), 50);
  </script>
</body>
</html>
